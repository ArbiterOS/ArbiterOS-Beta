# Metadata: The Anatomy of an Agent Message

For agents, a message is an atomic action. Therefore, its metadata must capture both its *communicative nature* (as a message) and its *functional nature* (as an action).

## 1. Message Metadata

This layer captures the **extrinsic** attributes of the message flow. These are immutable facts generated by the infrastructure or the model provider. They are essential for observability, debugging, and FinOps.

* **Identity & Timing**
* `id` (UUID): Unique identifier for the atomic action/message.
* `trace_id` (UUID): Global ID linking the entire interaction chain.
* `timestamp` (ISO8601): Precise time of generation.
* `latency_ms` (Int): Time taken to generate this specific token stream.


* **Infrastructure Context**
* `model_id`: The specific model version used (e.g., `gpt-4-turbo-2024-04-09`).
* `provider`: The inference provider (e.g., `openai`, `azure`, `anthropic`).
* `token_usage`:
* `input_tokens`: Cost of context.
* `output_tokens`: Cost of generation.


* `finish_reason`: Why the stream stopped (e.g., `stop`, `length`, `content_filter`).



## 2. Action Metadata

This layer captures the **intrinsic** characteristics of the action. These are defined by the agent's internal state and safety guardrails. (See *Properties of Atomic Actions* section for details).

* **Safety & Trust**
* `trustworthiness`: Source reliability (e.g., `VERIFIED`).
* `confidence`: Internal certainty score (e.g., `0.95`).
* `reversibility`: Can this be undone? (e.g., `FALSE`).


* **Access Control**
* `confidentiality`: Data sensitivity level (e.g., `PII`, `INTERNAL`).
* `authority`: Authorization level required (e.g., `HUMAN_APPROVED`).

Please refer to the [Atomic Agent Actions](./atomic_actions.md) document for a detailed taxonomy of atomic actions.

## 3. Semantic Metadata (Userdata, The Payload Context)

This is the most flexible layer. It involves using **Structured Outputs** or a secondary **Policy Agent** to parse the raw content (`content_text`) and extract domain-specific key-value pairs[^1].

* **Definition:** Keys are defined by **Extraction Policies** (e.g., `Policy<Finance>`, `Policy<CustomerSupport>`).
* **Extraction Mechanism:** Asynchronous extraction via small LLMs or Regex post-processing.

**Common Semantic Fields (Examples):**

* **Entities:**
* `user_name`: "Alice"
* `order_id`: "ORD-9981"
* `amount`: "50.00 USD"


* **Classification:**
* `intent`: "refund_request"
* `sentiment`: "frustrated"
* `topic`: "billing"


* **System States:**
* `error_type`: "RateLimitExceeded"
* `referenced_files`: ["logs.txt", "config.json"]

## 4. Environmental Metadata

For example, in coding agent: `OS_type`, `kernel_version`, `HOME_DIR`, `SECRET_DIR`... (Some could be changed on the fly...?)

For kernel implementation: add an api /post endpoint for collecting.

[^1]: This is proposed in <https://arxiv.org/abs/2510.05156>
